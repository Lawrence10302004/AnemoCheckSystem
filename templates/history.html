{% extends "base.html" %}

{% block title %}AnemoCheck - Classification History{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h1 class="display-6 mb-3">Classification History</h1>
        <p class="lead">View your complete anemia classification history over time.</p>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Hemoglobin Level History</h5>
        <div>
            <button class="btn btn-sm btn-outline-secondary" id="exportCsvBtn">
                <i class="fas fa-download me-1"></i> Export CSV
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="historyTable">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>WBC</th>
                        <th>RBC</th>
                        <th>HGB (g/dL)</th>
                        <th>HCT (%)</th>
                        <th>MCV (fL)</th>
                        <th>MCH (pg)</th>
                        <th>MCHC (g/dL)</th>
                        <th>PLT</th>
                        <th>NEU (%)</th>
                        <th>LYM (%)</th>
                        <th>MON (%)</th>
                        <th>EOS (%)</th>
                        <th>BAS (%)</th>
                        <th>IGR (%)</th>
                        <th>Classification</th>
                        <th>Confidence</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if history_data.records %}
                        {% for record in history_data.records %}
                        <tr class="
                            {% if record.predicted_class == 'Normal' %}table-success
                            {% elif record.predicted_class == 'Mild' %}table-warning
                            {% elif record.predicted_class in ['Moderate','Severe'] %}table-danger
                            {% endif %}">
                            <td>{{ record.created_at }}</td>
                            <td>{{ record.wbc }}</td>
                            <td>{{ record.rbc }}</td>
                            <td>{{ record.hgb }}</td>
                            <td>{{ record.hct }}</td>
                            <td>{{ record.mcv }}</td>
                            <td>{{ record.mch }}</td>
                            <td>{{ record.mchc }}</td>
                            <td>{{ record.plt }}</td>
                            <td>{{ record.neutrophils }}</td>
                            <td>{{ record.lymphocytes }}</td>
                            <td>{{ record.monocytes }}</td>
                            <td>{{ record.eosinophils }}</td>
                            <td>{{ record.basophil }}</td>
                            <td>{{ record.immature_granulocytes }}</td>
                            <td>
                                {% if record.predicted_class == 'Normal' %}
                                    <span class="badge bg-success">{{ record.predicted_class }}</span>
                                {% elif record.predicted_class == 'Mild' %}
                                    <span class="badge bg-warning text-dark">{{ record.predicted_class }}</span>
                                {% elif record.predicted_class == 'Moderate' %}
                                    <span class="badge bg-secondary">{{ record.predicted_class }}</span>
                                {% elif record.predicted_class == 'Severe' %}
                                    <span class="badge bg-danger">{{ record.predicted_class }}</span>
                                {% endif %}
                            </td>
                            <td>{{ (record.confidence * 100)|round(2, 'floor') }}%</td>
                            <td>
                                {% if record.notes %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                        data-bs-toggle="tooltip" title="{{ record.notes }}">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('result', record_id=record.id) }}" class="btn btn-sm btn-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-success" onclick="sendResultEmail({{ record.id }})" title="Send Result via Email">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="19" class="text-center">No classification records found</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if history_data.total_pages > 1 %}
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                Showing {{ ((history_data.page - 1) * history_data.per_page) + 1 }} to 
                {{ history_data.page * history_data.per_page if history_data.page * history_data.per_page < history_data.total else history_data.total }} 
                of {{ history_data.total }} classifications
            </div>
            <nav aria-label="Classification history pagination">
                <ul class="pagination pagination-sm mb-0">
                    {% if history_data.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('history', page=history_data.prev_num) }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in range(1, history_data.total_pages + 1) %}
                        {% if page_num == history_data.page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% elif page_num <= 3 or page_num > history_data.total_pages - 3 or (page_num >= history_data.page - 1 and page_num <= history_data.page + 1) %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('history', page=page_num) }}">{{ page_num }}</a>
                        </li>
                        {% elif page_num == 4 and history_data.page > 5 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% elif page_num == history_data.total_pages - 3 and history_data.page < history_data.total_pages - 4 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if history_data.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('history', page=history_data.next_num) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Main Row with left and right cards aligned -->
<div class="row d-flex align-items-stretch">
    <!-- Left: Hemoglobin Trend Visualization -->
    <div class="col-lg-8 mb-4 d-flex">
        <div class="card shadow-sm flex-fill h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Hemoglobin Trend Visualization</h5>
            </div>
            <div class="card-body">
                {% if history_data.records %}
                    <canvas id="historyChart" style="width:100%; min-height:400px;"></canvas>
                {% else %}
                    <div class="alert alert-info w-100 text-center">
                        <i class="fas fa-info-circle me-2"></i> No data available for visualization.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right: Statistics & Add Data -->
    <div class="col-lg-4 mb-4 d-flex flex-column">
        <div class="card shadow-sm mb-4 flex-fill">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Statistics</h5>
            </div>
            <div class="card-body">
                {% if history_data.records %}
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="small text-muted">Total Records</div>
                        <div class="fs-4 fw-bold">{{ history_data.total }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="small text-muted">Latest Hemoglobin</div>
                        <div class="fs-4 fw-bold">{{ history_data.records[0].hgb }} g/dL</div>
                    </div>
                </div>
                <hr>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No data available for statistics.
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-sm flex-fill">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Add New Data</h5>
            </div>
            <div class="card-body d-flex flex-column justify-content-center">
                <p>Enter a new hemoglobin value to get a classification:</p>
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary w-100 mt-auto">
                    <i class="fas fa-plus-circle me-1"></i> Add New Measurement
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- JSON data placed in a non-JS script tag so editors/linters won't treat Jinja tokens as JS syntax -->
<script id="records-data" type="application/json">{{ history_data.records|tojson }}</script>

<script>
// Attach export handler
(function(){
    const btn = document.getElementById('exportCsvBtn');
    if (btn) {
        btn.addEventListener('click', function(){
            // Non-blocking navigation to trigger download
            window.location.href = '/export/history.csv';
        });
    }
})();

function sendResultEmail(recordId) {
    // Show loading state
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    // Make AJAX request to send email
    fetch(`/send-result-email/${recordId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success notification
            showSuccessNotification({
                title: 'Email Sent Successfully',
                message: 'Your anemia test result has been sent to your email address.',
                details: `Email sent to: ${data.email}`,
                autoClose: true,
                autoCloseDelay: 3000
            });
        } else {
            // Show error notification
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending email:', error);
        alert('Error sending email. Please try again.');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips (if any)
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(t => new bootstrap.Tooltip(t));

    // Read JSON safely from the DOM (avoids inlining Jinja tokens in JS)
    let recordsData = [];
    const recordsEl = document.getElementById('records-data');
    if (recordsEl) {
        try {
            recordsData = JSON.parse(recordsEl.textContent || '[]');
        } catch (e) {
            console.error('Failed to parse records JSON', e);
            recordsData = [];
        }
    }

    if (recordsData && recordsData.length) {
        const labels = [];
        const hgbData = [];
        const pointColors = [];

        let normalCount = 0, mildCount = 0, moderateCount = 0, severeCount = 0;

        // iterate in reverse to preserve original unshift ordering
        recordsData.slice().reverse().forEach(record => {
            // created_at is a timestamp string like 'YYYY-MM-DD HH:MM:SS'
            labels.push(record.created_at ? record.created_at.split(' ')[0] : '');
            hgbData.push(record.hgb);
            if (record.predicted_class === 'Normal') {
                pointColors.push('rgba(32, 201, 151, 0.7)');
                normalCount++;
            } else if (record.predicted_class === 'Mild') {
                pointColors.push('rgba(255, 193, 7, 0.7)');
                mildCount++;
            } else if (record.predicted_class === 'Moderate') {
                pointColors.push('rgba(253, 126, 20, 0.7)');
                moderateCount++;
            } else if (record.predicted_class === 'Severe') {
                pointColors.push('rgba(220, 53, 69, 0.7)');
                severeCount++;
            } else {
                pointColors.push('rgba(108,117,125,0.7)');
            }
        });

        // Hemoglobin Trend Line Chart
        const canvas = document.getElementById('historyChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hemoglobin (g/dL)',
                        data: hgbData,
                        borderColor: 'rgba(75,192,192,1)',
                        backgroundColor: 'rgba(75,192,192,0.2)',
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: 6,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 5, max: 18, title: { display: true, text: 'Hemoglobin (g/dL)' } },
                        x: { title: { display: true, text: 'Date' } }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                normalLine: { type: 'line', yMin: 12, yMax: 12, borderColor: 'rgba(32,201,151,0.7)', borderWidth: 2, borderDash: [5,5], label: { enabled: true, content: 'Normal', position: 'start' } },
                                mildLine: { type: 'line', yMin: 10, yMax: 10, borderColor: 'rgba(255,193,7,0.7)', borderWidth: 2, borderDash: [5,5], label: { enabled: true, content: 'Mild', position: 'start' } },
                                moderateLine: { type: 'line', yMin: 8, yMax: 8, borderColor: 'rgba(253,126,20,0.7)', borderWidth: 2, borderDash: [5,5], label: { enabled: true, content: 'Moderate', position: 'start' } },
                                severeLine: { type: 'line', yMin: 6, yMax: 6, borderColor: 'rgba(220,53,69,0.7)', borderWidth: 2, borderDash: [5,5], label: { enabled: true, content: 'Severe', position: 'start' } }
                            }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}
